<%= turbo_frame_tag "model_picker" do %>
  <% defaults = PiModelsService.default_provider_model %>
  <% provider = conversation.pi_provider.presence || defaults[:provider] %>
  <% model = conversation.pi_model.presence || defaults[:model] %>
  <% selected = "#{provider}:#{model}" %>

  <% all_models = PiModelsService.models %>
  <% favorites = Rails.configuration.pi_models || [] %>
  <% favorite_values = favorites.map { |m| "#{m['provider']}:#{m['model']}" } %>

  <% selected_model = all_models.find { |m| "#{m['provider']}:#{m['model']}" == selected } %>
  <% selected_label = selected_model&.fetch('label', nil) || "#{model} (#{provider})" %>

  <%= form_with url: set_model_project_conversation_path(project, conversation),
                method: :patch,
                data: {
                  turbo_frame: "model_picker",
                  controller: "model-picker",
                  "model-picker-models-value": all_models.to_json,
                  "model-picker-favorites-value": favorite_values.to_json,
                  "model-picker-selected-value": selected,
                  "model-picker-selected-label-value": selected_label,
                  "model-picker-limit-value": 30
                },
                class: "w-full" do |f| %>

    <div class="relative w-full">
      <label class="block text-xs text-gray-400 mb-1" for="conversation_model_combobox">Model</label>

      <!-- Combobox input: click to open, type to filter -->
      <input id="conversation_model_combobox"
             type="text"
             autocomplete="off"
             inputmode="search"
             data-model-picker-target="input"
             data-action="focus->model-picker#open click->model-picker#open input->model-picker#filter keydown.esc->model-picker#close keydown.enter->model-picker#preventEnter"
             class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-purple-500"
             value="<%= selected_label %>" />

      <input type="hidden" name="conversation[selected_model]" value="<%= selected %>" data-model-picker-target="hidden" />

      <!-- Dropdown panel -->
      <div data-model-picker-target="panel"
           class="hidden absolute left-0 right-0 mt-2 bg-gray-800 border border-gray-700 rounded-xl shadow-xl z-50 overflow-hidden">

        <div class="flex items-center justify-between px-3 py-2 border-b border-gray-700">
          <div class="text-xs text-gray-400">Pick a model</div>
          <button type="button"
                  data-action="model-picker#close"
                  class="text-gray-400 hover:text-gray-200 px-2 py-1 rounded">âœ•</button>
        </div>

        <div data-model-picker-target="list" class="max-h-72 overflow-y-auto"></div>

        <div class="px-3 py-2 border-t border-gray-700 flex items-center justify-between">
          <label class="text-xs text-gray-400 flex items-center gap-2 select-none">
            <input type="checkbox"
                   data-model-picker-target="toggleAll"
                   data-action="change->model-picker#toggleAll"
                   class="rounded border-gray-600 bg-gray-700 text-purple-600 focus:ring-purple-500">
            <span>All models</span>
          </label>
          <div class="text-[11px] text-gray-500 truncate">Selected: <span class="text-gray-300"><%= provider %> / <%= model %></span></div>
        </div>
      </div>
    </div>
  <% end %>
<% end %>
