<%= turbo_frame_tag "model_picker" do %>
  <% defaults = PiModelsService.default_provider_model %>
  <% provider = conversation.pi_provider.presence || defaults[:provider] %>
  <% model = conversation.pi_model.presence || defaults[:model] %>
  <% selected = "#{provider}:#{model}" %>

  <% all_models = PiModelsService.models %>
  <% favorites = Rails.configuration.pi_models || [] %>
  <% favorite_values = favorites.map { |m| "#{m['provider']}:#{m['model']}" } %>

  <% selected_model = all_models.find { |m| "#{m['provider']}:#{m['model']}" == selected } %>
  <% selected_label = selected_model&.fetch('label', nil) || "#{model} (#{provider})" %>

  <%= form_with url: set_model_project_conversation_path(project, conversation),
                method: :patch,
                data: {
                  turbo_frame: "model_picker",
                  controller: "model-picker",
                  "model-picker-endpoint-value": available_models_project_conversation_path(project, conversation),
                  "model-picker-favorites-value": favorite_values.to_json,
                  "model-picker-selected-value": selected,
                  "model-picker-selected-label-value": selected_label,
                  "model-picker-limit-value": 30
                },
                class: "w-full" do |f| %>

    <div class="relative w-full">
      <label class="block text-xs text-gray-400 mb-1" for="conversation_model_combobox">Model</label>

      <%= render "shared/model_combobox",
          endpoint: available_models_project_conversation_path(project, conversation),
          field_name: "conversation[selected_model]",
          selected: selected,
          selected_label: selected_label,
          favorites: favorite_values,
          limit: 30,
          auto_submit: true,
          input_id: "conversation_model_combobox",
          input_class: "w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-purple-500",
          panel_class: "hidden absolute left-0 right-0 mt-2 bg-gray-800 border border-gray-700 rounded-xl shadow-xl z-50 overflow-hidden",
          list_class: "max-h-72 overflow-y-auto" %>

      <div class="px-3 py-2 border-t border-gray-700 flex items-center justify-between text-[11px] text-gray-500">
        <div class="truncate">Selected: <span class="text-gray-300"><%= provider %> / <%= model %></span></div>
        <div>Type to search</div>
      </div>
    </div>
  <% end %>
<% end %>
