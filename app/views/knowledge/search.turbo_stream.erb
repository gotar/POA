<%= turbo_stream.replace "kb_search" do %>
  <%= turbo_frame_tag "kb_search" do %>
    <% if @error.present? %>
      <div class="mt-3 text-sm text-red-300"><%= @error %></div>
    <% end %>

    <% if @q.present? %>
      <div class="mt-3 text-xs text-gray-500">Mode: <code class="text-gray-300"><%= @mode %></code> · Results: <%= @results.size %></div>
    <% end %>

    <div class="mt-3 space-y-2">
      <% @results.each do |r| %>
        <% path = r["file"].to_s.sub(%r{\Aqmd://[^/]+/}i, "") %>
        <%= link_to knowledge_note_path(path: path), class: "block bg-gray-750 hover:bg-gray-700 border border-gray-700 rounded-xl p-3" do %>
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-medium text-gray-100 truncate"><%= r["title"].presence || path %></div>
              <div class="text-xs text-gray-500 mt-1 truncate"><%= path %> · score <%= r["score"] %></div>
              <pre class="mt-2 text-xs text-gray-300 whitespace-pre-wrap"><%= r["snippet"].to_s %></pre>
            </div>
            <svg class="w-5 h-5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        <% end %>
      <% end %>

      <% if @q.present? && @results.empty? %>
        <div class="text-sm text-gray-500">No results.</div>
      <% end %>
    </div>
  <% end %>
<% end %>
