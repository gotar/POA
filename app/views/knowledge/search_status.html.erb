<%= turbo_frame_tag "kb_search", src: nil do %>
  <% if @knowledge_search.status == "queued" || @knowledge_search.status == "running" %>
    <div class="mt-3 flex items-center gap-2 text-sm text-gray-300">
      <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-purple-500"></div>
      <div>Searching (<%= @knowledge_search.mode %>)…</div>
    </div>
    <div class="mt-2 text-xs text-gray-500">
      This can take a while on Raspberry Pi for <code class="text-gray-300">vsearch</code>/<code class="text-gray-300">query</code>.
    </div>
  <% elsif @knowledge_search.status == "failed" %>
    <div data-poll-frame-done></div>
    <div class="mt-3 text-sm text-red-300"><%= @knowledge_search.error.presence || "Search failed" %></div>
  <% else %>
    <div data-poll-frame-done></div>

    <% results = (@knowledge_search.results || []) %>
    <div class="mt-3 text-xs text-gray-500">Mode: <code class="text-gray-300"><%= @knowledge_search.mode %></code> · Results: <%= results.size %></div>

    <div class="mt-3 space-y-2">
      <% results.each do |r| %>
        <% path = r["file"].to_s.sub(%r{\Aqmd://[^/]+/}i, "") %>
        <%= link_to knowledge_note_path(path: path), class: "block bg-gray-750 hover:bg-gray-700 border border-gray-700 rounded-xl p-3" do %>
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="font-medium text-gray-100 truncate"><%= r["title"].presence || path %></div>
              <div class="text-xs text-gray-500 mt-1 truncate"><%= path %> · score <%= r["score"] %></div>
              <pre class="mt-2 text-xs text-gray-300 whitespace-pre-wrap"><%= r["snippet"].to_s %></pre>
            </div>
            <svg class="w-5 h-5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        <% end %>
      <% end %>

      <% if results.empty? %>
        <div class="text-sm text-gray-500">No results.</div>
      <% end %>
    </div>
  <% end %>
<% end %>
