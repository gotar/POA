<%# Message form partial %>
<%= form_with model: [project, conversation, message],
    data: {
      turbo: true,
      controller: "message-form",
      action: "turbo:submit-end->message-form#reset turbo:submit-end->chat#scrollToBottom"
    },
    class: "flex items-end gap-3" do |f| %>

  <div class="flex-1 relative">
    <%= f.text_area :content,
        placeholder: "Type a message...",
        rows: 1,
        data: {
          message_form_target: "input",
          action: "keydown.enter->message-form#submitExceptShift input->message-form#autoResize"
        },
        class: "w-full bg-gray-700 border border-gray-600 rounded-xl px-4 py-3 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none max-h-32 pr-12"
    %>

    <!-- Action Buttons -->
    <div class="absolute right-2 top-2 flex gap-1">
      <button type="button"
              data-action="click->message-form#toggleQuestions"
              class="text-gray-400 hover:text-gray-200 p-1 rounded transition-colors"
              title="Ask questions">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </button>

      <% if project.todos.active.any? %>
        <button type="button"
                data-action="click->message-form#toggleTodoPanel"
                class="bg-yellow-500/20 text-yellow-400 text-xs px-2 py-1 rounded-full hover:bg-yellow-500/30 transition-colors">
          <%= project.todos.active.count %>
        </button>
      <% end %>
    </div>
  </div>

  <!-- Quick Questions Panel -->
  <div data-message-form-target="questionsPanel" class="hidden absolute bottom-full right-0 mb-2 w-80 bg-gray-800 border border-gray-700 rounded-xl shadow-xl z-50">
    <div class="p-3 border-b border-gray-700">
      <h4 class="font-medium text-gray-100">Quick Questions</h4>
      <p class="text-xs text-gray-400">Common questions to ask for requirements</p>
    </div>
    <div class="p-2 space-y-2">
      <button type="button" data-action="click->message-form#askQuestion"
              data-message-form-question-param="What are the main goals and objectives?"
              class="w-full text-left p-3 bg-gray-750 hover:bg-gray-700 rounded-lg transition-colors">
        <div class="font-medium text-gray-200">Goals & Objectives</div>
        <div class="text-xs text-gray-400">What are the main goals?</div>
      </button>

      <button type="button" data-action="click->message-form#askQuestion"
              data-message-form-question-param="What are the key features and functionality?"
              class="w-full text-left p-3 bg-gray-750 hover:bg-gray-700 rounded-lg transition-colors">
        <div class="font-medium text-gray-200">Key Features</div>
        <div class="text-xs text-gray-400">What functionality is needed?</div>
      </button>

      <button type="button" data-action="click->message-form#askQuestion"
              data-message-form-question-param="Who are the target users and what are their needs?"
              class="w-full text-left p-3 bg-gray-750 hover:bg-gray-700 rounded-lg transition-colors">
        <div class="font-medium text-gray-200">Target Users</div>
        <div class="text-xs text-gray-400">Who will use this?</div>
      </button>

      <button type="button" data-action="click->message-form#askQuestion"
              data-message-form-question-param="What are the constraints and limitations?"
              class="w-full text-left p-3 bg-gray-750 hover:bg-gray-700 rounded-lg transition-colors">
        <div class="font-medium text-gray-200">Constraints</div>
        <div class="text-xs text-gray-400">What are the limitations?</div>
      </button>

      <button type="button" data-action="click->message-form#askQuestion"
              data-message-form-question-param="What is the timeline and priority?"
              class="w-full text-left p-3 bg-gray-750 hover:bg-gray-700 rounded-lg transition-colors">
        <div class="font-medium text-gray-200">Timeline & Priority</div>
        <div class="text-xs text-gray-400">When is this needed?</div>
      </button>
    </div>
  </div>

  <!-- Quick TODO Panel -->
  <% if project.todos.active.any? %>
    <div data-message-form-target="todoPanel" class="hidden absolute bottom-full right-0 mb-2 w-80 bg-gray-800 border border-gray-700 rounded-xl shadow-xl z-50">
      <div class="p-3 border-b border-gray-700">
        <h4 class="font-medium text-gray-100">Active TODOs</h4>
        <p class="text-xs text-gray-400">Click to complete or modify</p>
      </div>
      <div class="max-h-64 overflow-y-auto p-2 space-y-2">
        <% project.todos.active.order(:position, :priority).each do |todo| %>
          <div class="flex items-center gap-3 p-2 bg-gray-750 rounded-lg hover:bg-gray-700 transition-colors group">
            <input type="checkbox"
                   id="todo_<%= todo.id %>"
                   data-action="change->message-form#completeTodo"
                   data-message-form-todo-id-param="<%= todo.id %>"
                   class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500 focus:ring-2">
            <div class="flex-1 min-w-0">
              <p class="text-sm text-gray-200 truncate"><%= todo.content %></p>
              <% if todo.priority.present? %>
                <span class="text-xs text-purple-400">P<%= todo.priority %></span>
              <% end %>
            </div>
            <button data-action="click->message-form#editTodo"
                    data-message-form-todo-id-param="<%= todo.id %>"
                    class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-gray-200 transition-opacity">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
            </button>
          </div>
        <% end %>
      </div>
      <div class="p-3 border-t border-gray-700" data-message-form-todo-add-container>
        <div class="flex gap-2">
          <input type="text"
                 placeholder="Add new todo..."
                 data-action="keydown.enter->message-form#addTodo"
                 class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-sm text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-purple-500">
          <button type="button"
                  data-action="click->message-form#addTodo"
                  class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded text-sm font-medium transition-colors">
            Add
          </button>
        </div>
      </div>
    </div>
  <% end %>

  <%= f.submit "Send",
      data: { message_form_target: "submit" },
      class: "bg-purple-600 hover:bg-purple-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white px-5 py-3 rounded-xl font-medium transition-colors flex items-center gap-2"
  %>
<% end %>
