<div id="<%= dom_id(message) %>" data-message-role="<%= message.role %>" class="flex <%= message.role == 'user' ? 'justify-end' : 'justify-start' %>">
  <div class="max-w-[85%] sm:max-w-[75%]">
    <% if message.role == 'user' %>
      <!-- User Message -->
      <div class="bg-purple-600 text-white rounded-2xl rounded-br-md px-4 py-3">
        <div class="prose prose-invert prose-sm max-w-none">
          <%= simple_format(h(message.content)) %>
        </div>

        <!-- Attachments -->
        <% if message.attachments.any? %>
          <div class="mt-3 space-y-2">
            <% message.attachments.each do |attachment| %>
              <div class="flex items-center gap-3 p-2 bg-purple-700 rounded-lg">
                <% if attachment.image? %>
                  <%= image_tag attachment.file_url, class: "w-8 h-8 object-cover rounded", alt: attachment.name %>
                <% elsif attachment.video? %>
                  <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                  </div>
                <% else %>
                  <div class="w-8 h-8 bg-gray-600 rounded flex items-center justify-center">
                    <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                  </div>
                <% end %>

                <div class="flex-1 min-w-0">
                  <a href="<%= attachment.file_url %>" target="_blank" class="text-sm text-purple-200 hover:text-purple-100 truncate block">
                    <%= attachment.name %>
                  </a>
                  <div class="text-xs text-purple-300">
                    <%= number_to_human_size(attachment.file_size) %> â€¢ <%= attachment.content_type %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
      <div class="text-xs text-gray-500 mt-1 text-right flex items-center justify-end gap-2">
        <button type="button" data-action="remember#open" class="text-xs text-purple-200/90 hover:text-white underline underline-offset-2">Remember</button>
        <span><%= message.created_at.strftime('%H:%M') %></span>
      </div>
    <% else %>
      <!-- Assistant Message -->
      <div class="bg-gray-800 border border-gray-700 text-gray-100 rounded-2xl rounded-bl-md px-4 py-3" data-controller="syntax-highlight">
        <div class="prose prose-invert prose-sm max-w-none">
          <% if message.content.present? %>
            <% if message.content.start_with?("âŒ", "â°", "ðŸ”§") %>
              <!-- Error message -->
              <div class="flex items-start gap-2 text-red-300">
                <span class="text-lg"><%= message.content[0] %></span>
                <div class="flex-1">
                  <%= simple_format_with_markdown(message.content[2..-1]) %>
                  <div class="mt-2">
                    <button type="button"
                            onclick="location.reload()"
                            class="text-xs bg-red-800 hover:bg-red-700 text-red-200 px-2 py-1 rounded transition-colors">
                      Try Again
                    </button>
                  </div>
                </div>
              </div>
            <% else %>
              <%= simple_format_with_markdown(message.content) %>
            <% end %>
          <% else %>
            <div class="flex items-center gap-2 text-gray-400">
              <div class="flex gap-1">
                <span class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                <span class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                <span class="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
              </div>
              <span>Thinking...</span>
            </div>
          <% end %>
        </div>

        <!-- Tool calls area -->
        <div id="<%= dom_id(message) %>_tools" class="mt-2"></div>
      </div>
      <div class="text-xs text-gray-500 mt-1 flex items-center gap-2 flex-wrap">
        <button type="button" data-action="remember#open" class="text-xs text-gray-400 hover:text-gray-200 underline underline-offset-2">Remember</button>
        <span><%= message.created_at.strftime('%H:%M') %></span>

        <% if message.metadata.present? %>
          <!-- Model Info -->
          <% if message.metadata["model"].present? %>
            <span class="text-gray-600">â€¢</span>
            <span class="text-purple-400" title="Model: <%= message.metadata["model"] %>">
              <%= message.metadata["model"].to_s.split('/').last || message.metadata["model"] %>
            </span>
          <% end %>

          <!-- Token Usage -->
          <% if message.metadata["usage"].present? %>
            <% usage = message.metadata["usage"] %>
            <span class="text-gray-600">â€¢</span>
            <span class="flex items-center gap-1" title="Tokens: <%= usage["total_tokens"] %> total (<%= usage["input_tokens"] %> in / <%= usage["output_tokens"] %> out)">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <%= number_with_delimiter(usage["total_tokens"] || 0) %>
            </span>

            <!-- Cost -->
            <% if usage["cost"].present? %>
              <% cost_value = usage["cost"].is_a?(Hash) ? usage["cost"]["total"] : usage["cost"] %>
              <span class="text-gray-600">â€¢</span>
              <span class="text-green-400" title="Cost: $<%= cost_value %>">
                $<%= sprintf('%.4f', cost_value.to_f) %>
              </span>
            <% end %>
          <% end %>

          <!-- Context/Stop Reason -->
          <% if message.metadata["stop_reason"].present? && message.metadata["stop_reason"] != "stop" %>
            <span class="text-gray-600">â€¢</span>
            <span class="text-yellow-400" title="Stop reason: <%= message.metadata["stop_reason"] %>">
              <%= message.metadata["stop_reason"] %>
            </span>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
