<%= turbo_frame_tag "pk_create_topic" do %>
  <% if suggestions.present? %>
    <div class="bg-yellow-900/20 border border-yellow-800 rounded-xl p-3 mb-3">
      <div class="text-sm text-yellow-200 font-medium">Possible duplicate topic</div>
      <div class="text-xs text-yellow-300/80 mt-1">
        Knowledge changes over time — prefer updating an existing note when it matches.
      </div>

      <div class="mt-3 space-y-2">
        <% suggestions.each do |r| %>
          <% rel = r["file"].to_s.sub(%r{\Aqmd://[^/]+/}i, "") %>
          <% title = r["title"].presence || rel %>
          <div class="bg-gray-900/40 border border-gray-700 rounded-lg p-3">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="text-sm text-gray-100 font-medium truncate"><%= title %></div>
                <div class="text-xs text-gray-500 truncate"><%= rel %> · score <%= r["score"] %></div>
              </div>
              <div class="flex items-center gap-2 flex-shrink-0">
                <%= link_to "Open", project_personal_knowledge_note_path(project, path: rel), class: "text-xs text-purple-300 hover:text-purple-200" %>
                <%= button_to "Update this", project_personal_knowledge_topics_path(project),
                      method: :post,
                      params: prefill.merge(existing_path: rel),
                      class: "text-xs bg-yellow-700 hover:bg-yellow-600 text-white px-2 py-1 rounded",
                      form: { data: { turbo: true } } %>
              </div>
            </div>
            <% if r["snippet"].present? %>
              <pre class="mt-2 text-[11px] text-gray-300 whitespace-pre-wrap"><%= r["snippet"].to_s %></pre>
            <% end %>
          </div>
        <% end %>
      </div>

      <div class="mt-3 flex items-center justify-end gap-2">
        <%= button_to "Create new anyway", project_personal_knowledge_topics_path(project),
              method: :post,
              params: prefill.merge(force: 1),
              class: "text-xs bg-gray-700 hover:bg-gray-600 text-gray-100 px-3 py-2 rounded-lg",
              form: { data: { turbo: true } } %>
      </div>
    </div>
  <% end %>

  <%= form_with url: project_personal_knowledge_topics_path(project), method: :post, class: "space-y-2" do %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
      <input name="title" value="<%= prefill[:title].to_s %>" placeholder="Title" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-gray-100 placeholder-gray-400" />
      <input name="tags" value="<%= prefill[:tags].to_s %>" placeholder="tags (comma or space)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-gray-100 placeholder-gray-400" />
      <input name="version" value="<%= prefill[:version].to_s %>" placeholder="version (optional)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-gray-100 placeholder-gray-400" />
      <input name="source" value="<%= prefill[:source].to_s %>" placeholder="source URL (optional)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-gray-100 placeholder-gray-400" />
    </div>
    <textarea name="body" rows="4" placeholder="Optional initial content / examples…" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-sm text-gray-100 placeholder-gray-400"><%= prefill[:body].to_s %></textarea>

    <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm">Create</button>
  <% end %>
<% end %>
