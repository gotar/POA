<%#
  Global QMD health banner.
  Uses RuntimeMetric values written by SystemHeartbeatJob.
%>

<% qmd_bin = (@global_diagnostics || {})["diagnostics.qmd_binary"].to_s %>
<% qmd_status = (@global_diagnostics || {})["qmd.last_status"].to_s %>
<% qmd_error = (@global_diagnostics || {})["qmd.last_error"].to_s %>
<% qmd_checked_at = (@global_diagnostics || {})["qmd.last_check_at"].to_s %>

<% show = (qmd_bin == "missing") || (qmd_status.present? && qmd_status != "ok") %>

<% if show %>
  <div class="mx-auto max-w-6xl px-4 pt-3">
    <div class="rounded-xl border px-4 py-3 text-sm <%= qmd_bin == 'missing' ? 'bg-red-900/30 border-red-700 text-red-100' : 'bg-yellow-900/30 border-yellow-700 text-yellow-100' %>">
      <div class="font-semibold">QMD / Knowledge search diagnostics</div>
      <div class="mt-1 text-xs opacity-90">
        <% if qmd_bin == "missing" %>
          QMD binary is missing from PATH.
        <% else %>
          Status: <span class="font-mono"><%= qmd_status.presence || "unknown" %></span>
        <% end %>
        <% if qmd_error.present? %>
          — <span class="font-mono"><%= qmd_error %></span>
        <% end %>
        <% if qmd_checked_at.present? %>
          — last check: <span class="font-mono"><%= qmd_checked_at %></span>
        <% end %>
      </div>

      <div class="mt-2 flex items-center gap-4 text-xs">
        <%= link_to "Open Monitoring", monitoring_path, class: "underline underline-offset-2" %>
        <%= link_to "Open Knowledge", knowledge_path, class: "underline underline-offset-2" %>
      </div>
    </div>
  </div>
<% end %>
