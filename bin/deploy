#!/usr/bin/env bash

set -euo pipefail

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
MISE_BIN="${HOME}/.local/bin/mise"

run_build() {
  if [[ -x "$MISE_BIN" && -f "$PROJECT_ROOT/.mise.toml" ]]; then
    local ruby_root ruby_bin
    ruby_root="$($MISE_BIN where ruby@3.4)"
    ruby_bin="$ruby_root/bin"

    echo "Building site (clean env, ruby from mise: $ruby_root)..."

    if ! env -i HOME="$HOME" PATH="$ruby_bin:/usr/local/bin:/usr/bin:/bin" BUNDLE_GEMFILE="$PROJECT_ROOT/Gemfile" \
      "$ruby_bin/bundle" check >/dev/null 2>&1; then
      env -i HOME="$HOME" PATH="$ruby_bin:/usr/local/bin:/usr/bin:/bin" BUNDLE_GEMFILE="$PROJECT_ROOT/Gemfile" \
        "$ruby_bin/bundle" install
    fi

    env -i HOME="$HOME" PATH="$ruby_bin:/usr/local/bin:/usr/bin:/bin" BUNDLE_GEMFILE="$PROJECT_ROOT/Gemfile" \
      "$ruby_bin/bundle" exec ./bin/build
  else
    echo "Building site..."
    bundle exec ./bin/build
  fi
}

cd "$PROJECT_ROOT"
run_build

echo "Committing build changes..."
git add build
if git diff --cached --quiet; then
  echo "No changes to deploy"
  exit 0
fi

git commit -m "ðŸš€ deploy: update site build"

echo "Pushing to master..."
git push origin master

echo "Deploying to gh-pages..."
if ! git subtree push --prefix build origin gh-pages; then
  echo "Deployment failed. This usually means gh-pages has diverged."
  echo "You can force update by running:"
  echo "  git push origin :gh-pages"
  echo "  git subtree push --prefix build origin gh-pages"
  exit 1
fi

echo "âœ… Deployment successful!"
echo "Site will be live at https://aikido-polska.eu/ in a few minutes"
